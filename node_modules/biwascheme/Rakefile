# リリース手順
# - rake copy でbiwascheme-x.y.z.jsを作る
# - rake publish ALL=1
#   - release/biwascheme.jsをコピーする
#
# Note: この方式はわかりにくいよなあ(コマンド間違うと開発中のbiwascheme.jsがwebsiteに上がってしまうのがだめだと思う)
# リリース毎にmake websiteする、というのが良いと思いました。


desc "cpでrelease/biwascheme-x.y.z.jsをつくる"
task :copy do
  ver = File.read("VERSION").chomp
  sh "cp release/biwascheme.js release/biwascheme-#{ver}.js"
  sh "cp release/biwascheme-min.js release/biwascheme-#{ver}-min.js"
end

desc "build"
task :build do
  sh "make website"
end

desc "git ci, git tag and git push"
task :release do
  sh "git status"
  v = "v#{File.read('VERSION').chomp}"
  puts "release as #{v}? [y/N]"
  break unless $stdin.gets.chomp == "y"

  sh "git ci -am '#{v}'"
  sh "git tag '#{v}'"
  sh "git push origin master --tags"
  sh "npm publish"
end

task :scp do
  sh [
    "rsync -e 'ssh -p 28641'",
    "-avr --progress",
    "--delete",
    (if ENV['ALL'] 
       "--exclude=',' --exclude='.git' --exclude='node_modules' ."
     else
       "doc index.html website"
     end
    ),
    "sakura:sites/biwascheme.org/",
  ].join(" ")
end

desc "build and scp to server (send only doc and index.html by default, use ALL=1 to copy all)"
task :publish => [:build, :scp]

task :default do
  sh "./bin/biwas ,/a.scm"
end
